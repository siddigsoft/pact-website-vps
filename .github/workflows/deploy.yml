name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SSH_PORT || '22' }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # Sync files to VPS using rsync
      - name: Sync files to VPS
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='.github' \
            --exclude='*.log' \
            -e "ssh -p ${{ secrets.SSH_PORT || '22' }} -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH || '/opt/pact-website' }}/

      # Write env file on VPS
      - name: Write env file on VPS
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            APP_DIR="${APP_DIR:-${{ secrets.REMOTE_PATH || '/opt/pact-website' }}}"
            cd "$APP_DIR"
            
            # Create .env file if it doesn't exist
            if [ ! -f ".env" ]; then
              echo "Creating .env file..."
              
              # Generate random session secret
              SESSION_SECRET=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9')
              
              # Create .env file with required variables
              cat > .env << EOF
            # Database
            DATABASE_URL=postgresql://neondb_owner:npg_aTqvez1r0bkA@ep-holy-sea-ahwpuzyd-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require
            
            # Session Secret (generate a secure random string)
            SESSION_SECRET=${SESSION_SECRET}
            
            # Frontend API proxy URL
            VITE_API_URL=http://138.68.104.122
            EOF
              
              echo ".env file created successfully with generated SESSION_SECRET."
            else
              echo ".env file already exists, skipping creation."
            fi

      # Build + restart services on the VPS
      - name: Deploy via Docker Compose
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -euo pipefail

            APP_DIR="${APP_DIR:-${{ secrets.REMOTE_PATH || '/opt/pact-website' }}}"
            COMPOSE_FILE="${COMPOSE_FILE:-docker-compose.prod.yml}"

            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # Stop existing containers if they exist
            echo "Stopping existing containers..."
            docker compose -f "$COMPOSE_FILE" down || true

            # Check for and stop any service using port 80
            echo "Checking for services using port 80..."
            if lsof -ti:80 > /dev/null 2>&1; then
              echo "Port 80 is in use, attempting to free it..."
              # Try to stop nginx if running as a service
              systemctl stop nginx 2>/dev/null || true
              # Try to stop apache if running
              systemctl stop apache2 2>/dev/null || true
              # Kill any process using port 80 (be careful with this)
              fuser -k 80/tcp 2>/dev/null || true
            fi

            # Check for and stop any Docker containers using port 80
            CONTAINER_USING_80=$(docker ps --format "{{.ID}}\t{{.Ports}}" | grep ":80->" | awk '{print $1}' | head -1)
            if [ ! -z "$CONTAINER_USING_80" ]; then
              echo "Stopping Docker container using port 80: $CONTAINER_USING_80"
              docker stop "$CONTAINER_USING_80" || true
            fi

            # Build and restart
            echo "Building and starting containers..."
            docker compose -f "$COMPOSE_FILE" pull || true
            docker compose -f "$COMPOSE_FILE" build --pull
            docker compose -f "$COMPOSE_FILE" up -d --remove-orphans

            # Light cleanup to help with disk space
            docker image prune -f
            docker volume prune -f

            echo "Deployment completed successfully!"

